function reloadViews(){readCookie(),drawJSON(),drawMD(),drawHTML()}function rewriteJSONfromJSON(){var a=$("#json .json").val();if(0==a.length)json={};else{var b=JSON.parse(a);json=b}drawMD(),drawHTML(),writeCookie()}function drawHTML(){var a=$("#html");$("#html .html").empty(),json.title&&a.find("h3.title").text(json.title),json.modules&&json.modules instanceof Array&&$.each(json.modules,function(a,b){drawModuleHTML(a,b)}),drawJSON()}function drawModuleHTML(a,b){var c=$("#html .html"),d=$("<div></div>").attr({"class":"module","data-index":a});if(c.append(d),b.preparagraph){var e=$("<div></div>").attr({"class":"preparagraph"}).html(marked(b.preparagraph));d.append(e)}if(b.code){var f=$("<pre></pre>").attr({"class":"pre"});d.append(f);var g=$("<code></code>").attr({"class":"code"}).html(b.code);f.append(g)}if(b.postparagraph){var h=$("<div></div>").attr({"class":"postparagraph"}).html(marked(b.postparagraph));d.append(h)}}function drawJSON(){var a=$("#json .json"),b=JSON.stringify(json,void 0,2);a.html(b);var c=$("#md").height();a.height(c-40),a.off().on({change:function(){rewriteJSONfromJSON()},keypress:function(){rewriteJSONfromJSON()},blur:function(){rewriteJSONfromJSON()}})}function drawMD(){var a=$("#md .title");json.title&&a.val(json.title),a.off().on({change:function(){rewriteJSONfromMD()},keyup:function(){rewriteJSONfromMD()},blur:function(){rewriteJSONfromMD()}}),$("#md .md").empty(),json.modules&&json.modules instanceof Array&&$.each(json.modules,function(a,b){drawModuleMD(a,b,!1)})}function addModule(){var a=!1;drawModuleMD(0,a,!0)}function drawModuleMD(a,b){var c=$("#md .md"),d=$("<div></div>").attr({"class":"module","data-index":a});c.append(d);var e=$("<button></button>").attr({"class":"btn btn-default btn-sm pull-right"}).html('<i class="icon ion-close"></i>');d.append(e),e.click(function(){$(this).parent().remove(),rewriteJSONfromMD()});var f=$("<h5></h5>").text("Preface");d.append(f);var g=$("<textarea></textarea>").attr({"class":"preparagraph"}).val(b.preparagraph);d.append(g),b.preparagraph&&g.val(b.preparagraph),g.off().on({change:function(){rewriteJSONfromMD()},keyup:function(){rewriteJSONfromMD()},blur:function(){rewriteJSONfromMD()}});var h=$("<h5></h5>").text("Code");d.append(h);var i=$("<textarea></textarea>").attr({"class":"code",wrap:"off"});d.append(i),b.code&&i.val(b.code);var j=$("<h5></h5>").text("Solutions");d.append(j);var k=$("<div></div>").attr({"class":"solutions"});d.append(k),b.solutions&&$.each(b.solutions,function(b,c){var d=$("<input>").attr({type:"text","class":"solution","data-index":a}).val(c);k.append(d),d.off().on({change:function(){rewriteJSONfromMD()},keyup:function(){rewriteJSONfromMD()},blur:function(){rewriteJSONfromMD()}})});var l=$("<h5></h5>").text("Explanation");d.append(l);var m=$("<textarea></textarea>").attr({"class":"postparagraph"});d.append(m),b.postparagraph&&m.val(b.postparagraph),m.off().on({change:function(){rewriteJSONfromMD()},keyup:function(){rewriteJSONfromMD()},blur:function(){rewriteJSONfromMD()}}),studyCode(i.get(0),a),i.on({change:function(){studyCode(this,a)},keyup:function(){studyCode(this,a)},blur:function(){studyCode(this,a)}})}function studyCode(a,b){var c=$(a),d=c.val(),e=d.match(/\__/g),f=e?e.length:0,g=c.siblings(".solutions"),h=g.children(".solution").length;if(f>h)for(var i=f-h;i>0;i--)create_solution_input(g,"",b);if(h>f)for(var i=h-f;i>0;i--)remove_solution_input(g);rewriteJSONfromMD()}function create_solution_input(a,b,c){var d=$("<input>").attr({type:"text","class":"solution","data-index":c}).val(b);d.off().on({change:function(){rewriteJSONfromMD()},keyup:function(){rewriteJSONfromMD()},blur:function(){rewriteJSONfromMD()}}),a.append(d)}function remove_solution_input(a){a.children(".solution").last().remove()}function rewriteJSONfromMD(){console.log("rewriteJSONfromMD");var a=$("#md .md"),b=$("#md .title").val(),c=a.children(".module"),d={},e=[];c.each(function(a){var b=$(this),c=[],d=b.find(".solution");d.each(function(){c.push($(this).val())});var f={preparagraph:b.find(".preparagraph").first().val(),code:b.find(".code").first().val(),solutions:c,postparagraph:b.find(".postparagraph").first().val()};e[a]=f}),d.title=b,d.modules=e,json=d,drawJSON(),drawHTML(),writeCookie()}function writeCookie(){var a=JSON.stringify(json,void 0,2);localStorage.setItem("json",a),console.log("Write local storage")}function readCookie(){localStorage.getItem("json")&&(console.log("Read local storage"),json=$.parseJSON(localStorage.getItem("json")))}function reset(){json=json_reset,writeCookie(),reloadViews()}$(function(){Modernizr.localstorage||console.log("No html5 storage supported"),reloadViews()});var json_reset={modules:[{postparagraph:"Explanation text, with ***markdown*** too.",preparagraph:"Preface text with `markdown`",code:"val left = 2\nval right = 1\nassert(leff + right == __)",solutions:["3"]}],title:"My Koans"},json=json_reset;